name: Mddplayer Release

# 当新的 tag 被推送到 GitHub 时触发此工作流
on:
    push:
        tags:
            - 'v*' # 匹配所有以 'v' 开头的标签，例如 v1.5.0

env:
    CARGO_TERM_COLOR: always # 启用 Cargo 终端颜色输出
    # 您的项目名称，用于构建和打包的命名
    PROJECT_NAME: mddplayer

jobs:
    # ----------------------------------------
    # 1. 跨平台构建作业
    # ----------------------------------------
    build_release:
        name: Build on ${{ matrix.os }} for ${{ matrix.target }}
        # 使用矩阵定义要构建的平台
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                # 定义目标 OS 和对应的 Rust Target
                include:
                    # Windows (MSVC)
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      archive_ext: zip
                      bin_name: mddplayer.exe
                      
                    # Linux (GNU)
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive_ext: tar.gz
                      bin_name: mddplayer
                      
                    # macOS (Darwin)
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      archive_ext: zip
                      bin_name: mddplayer
                      
        steps:
            # 1.1 检出代码
            - uses: actions/checkout@v4
            
            # 1.2 安装 Rust 工具链和目标平台
            - name: Install Rust ${{ matrix.target }}
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: stable
                  target: ${{ matrix.target }}
                  
            # 1.3 缓存 Cargo 依赖，加速构建
            - name: Cache Cargo dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-cargo-

            # 1.4 构建 Release 版本
            - name: Build project
              run: cargo build --release --target ${{ matrix.target }}
              # winres 是 build-dependencies，仅在 Windows 上被激活，无需担心跨平台问题

            # 1.5 准备打包的名称和路径
            - name: Set archive variables
              id: archive_vars
              shell: bash
              run: |
                  # 提取 Tag 名称 (例如 v1.5.0)
                  TAG_NAME=${GITHUB_REF#refs/tags/}
                  
                  # 创建打包文件名: mddplayer-v1.5.0-x86_64-pc-windows-msvc.zip
                  ARCHIVE_NAME="${{ env.PROJECT_NAME }}-${TAG_NAME}-${{ matrix.target }}.${{ matrix.archive_ext }}"
                  
                  echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
                  echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

            # 1.6 打包可执行文件
            - name: Archive executable
              shell: bash
              run: |
                  # 确定可执行文件的路径
                  BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.bin_name }}"
                  
                  # 创建打包文件夹
                  mkdir ${{ env.PROJECT_NAME }}
                  
                  # 复制二进制文件到打包文件夹
                  cp $BINARY_PATH ${{ env.PROJECT_NAME }}/
                  
                  # 打包
                  if [ "${{ matrix.archive_ext }}" = "zip" ]; then
                      zip -r ${{ steps.archive_vars.outputs.archive_name }} ${{ env.PROJECT_NAME }}
                  else
                      tar -czf ${{ steps.archive_vars.outputs.archive_name }} ${{ env.PROJECT_NAME }}
                  fi
                  
            # 1.7 上传打包文件作为 Workflow Artifacts
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.archive_vars.outputs.archive_name }}
                  path: ${{ steps.archive_vars.outputs.archive_name }}
                  # 仅保留在上传 Release 步骤中需要的文件

    # ----------------------------------------
    # 2. 发布作业 (依赖于构建作业)
    # ----------------------------------------
    create_release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: [build_release] # 确保所有构建都已完成
        
        steps:
            # 2.1 检出代码 (用于获取 tag)
            - uses: actions/checkout@v4
            
            # 2.2 下载所有构建作业生成的 Artifacts
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  
            # 2.3 创建 GitHub Release (这将创建草稿 Release)
            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  # Release 名称使用 Tag 名称
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  # 自动生成 Release Note
                  generate_release_notes: true
                  # 上传 Artifacts 文件夹中的所有文件作为附件
                  files: artifacts/*/*
              env:
                  # 使用 GITHUB_TOKEN 进行认证
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
